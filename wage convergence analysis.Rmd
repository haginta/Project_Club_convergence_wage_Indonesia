---
title: "Convergence Clubs of wage in 34 Indonesian Provinces"
output: html_notebook
---

#Activate necessary libraries
```{r}
library(ConvergenceClubs)
library(tidyverse)
library(janitor)
library(tibble)
library(data.table)
```


#Part I: Nominal Wage using definition "A" of worker
#Load the data
```{r}
library(readxl)
nominal.wage <- read_excel("WS Labour_new.xlsx", 
    sheet = "nominal_wage_A")
nominal.wage
```

#Select data only from 2008 onwards and remove "Region" column, and remove the observation of Indonesia
```{r}
nominal.wage <- nominal.wage %>% 
  select(-c(1,3:5)) %>% 
  subset(Province!="National")
```

#transform the wage series to log
```{r}
nominal.wage.log <- log(nominal.wage[,-1])
nominal.wage.log
```

#Remove short-run noise using HP filter
```{r}
f.nominal.wage.log <- apply(nominal.wage.log, 1, 
function(x){mFilter::hpfilter(x, freq=6.25, type="lambda")$trend} ) 
f.nominal.wage.log <- data.frame(Province = nominal.wage[,1], t(f.nominal.wage.log), stringsAsFactors=FALSE ) 
colnames(f.nominal.wage.log) <- colnames(nominal.wage) 
```

#Inspect the filtered data
```{r}
head(f.nominal.wage.log)
```

#Run the log-t-test
```{r}
H.nominal <- computeH(f.nominal.wage.log[,-1], quantity = "H")
round(estimateMod(H.nominal, time_trim=0.333, HACmethod = "FQSB"), 3)
```

#find convergence clubs
```{r}
clubs.nominal <- findClubs(f.nominal.wage.log, dataCols=2:14, unit_names = 1, refCol=14,
time_trim=0.333, cstar=0, HACmethod = 'FQSB')
```

```{r}
summary(clubs.nominal)
```

```{r}
print(clubs.nominal)
```

```{r}
plot(clubs.nominal)
```

```{r}
plot(clubs.nominal, clubs=NULL, avgTP = TRUE, legend=TRUE)
```

#Merge clubs
```{r}
mclubs.nominal <- mergeClubs(clubs.nominal, mergeMethod='PS')
summary(mclubs.nominal)
```

```{r}
mclubs.nominal
```

```{r}
plot(mclubs.nominal)
```

```{r}
plot(mclubs.nominal, clubs=NULL, avgTP = TRUE, legend=TRUE)
```

--------------
#Part II: Real Wage using definition "A" of worker
#Load the data
```{r}
library(readxl)
real.wage <- read_excel("WS Labour_new.xlsx", 
    sheet = "real_wage_A")
real.wage
```

#Select data only from 2008 onwards and remove "Region" column, and remove the observation of Indonesia
```{r}
real.wage <- real.wage %>% 
  select(-c(1,3:5)) %>% 
  subset(Province!="National")
```

#transform the wage series to log
```{r}
real.wage.log <- log(real.wage[,-1])
real.wage.log
```

#Remove short-run noise using HP filter
```{r}
f.real.wage.log <- apply(real.wage.log, 1, 
function(x){mFilter::hpfilter(x, freq=6.25, type="lambda")$trend} ) 
f.real.wage.log <- data.frame(Province = real.wage[,1], t(f.real.wage.log), stringsAsFactors=FALSE ) 
colnames(f.real.wage.log) <- colnames(real.wage) 
```

#Inspect the filtered data
```{r}
head(f.real.wage.log)
```

#Run the log-t-test
```{r}
H.real <- computeH(f.real.wage.log[,-1], quantity = "H")
round(estimateMod(H.real, time_trim=0.333, HACmethod = "FQSB"), 3)
```

#find convergence clubs
```{r}
clubs.real <- findClubs(f.real.wage.log, dataCols=2:14, unit_names = 1, refCol=14,
time_trim=0.333, cstar=0, HACmethod = 'FQSB')
```

```{r}
summary(clubs.real)
```

```{r}
print(clubs.real)
```

```{r}
plot(clubs.real)
```

```{r}
plot(clubs.real, clubs=NULL, avgTP = TRUE, legend=TRUE)
```

#Merge clubs
```{r}
mclubs.real <- mergeClubs(clubs.real, mergeMethod='PS')
summary(mclubs.real)
```

```{r}
mclubs.real
```

```{r}
plot(mclubs.real)
```

```{r}
plot(mclubs.real, clubs=NULL, avgTP = TRUE, legend=TRUE)
```

```{r}
class(mclubs.nominal)
```

```{r}
table.mclubs.nom <- map(mclubs.nominal, as.data.table)
df.mclubs.nom <- rbindlist(table.mclubs.nom, fill = T, idcol = T)
df.mclubs.nom
```
```{r}
colnames(df.mclubs.nom)[5] <- "Province"
df.mclubs.nom
```


```{r}
nominal.wage.club <- as.data.frame(
  inner_join(f.nominal.wage.log, df.mclubs.nom, by="Province") %>% 
  select(-contains(c("id","model")))
  ) 
nominal.wage.club
```

#Generate relative value for all clubs
```{r}
relative <- list()
for(a in 2:14) {
  relative[[a]] <- data.frame(nominal.wage.club$Province, nominal.wage.club[,a]/mean(nominal.wage.club[,a]))
colnames(relative[[a]])[1]<- "Province"
colnames(relative[[a]])[2]<- 
paste("rel",colnames(nominal.wage.club)[a],sep="_")
}

for (x in 2:13) {
  relative[[x+1]]<-left_join(relative[[x]],relative[[x+1]], by="Province")
}
```

```{r}
table.relative <- map(relative, as.data.table)
df.relative <- rbindlist(table.relative, fill = T, idcol = T) %>% drop_na()
library(plyr)
df.relative <- join(df.relative,nominal.wage.club,by=c('Province')) %>% 
  select(Province,contains("rel"),clubs)
  
df.relative <- as.data.frame(df.relative)
```

```{r}
colnames(df.relative) <- gsub("rel_","",colnames(df.relative))
df.relative
```

```{r}
df.relative.long <- df.relative %>%  pivot_longer(-c(Province,clubs), names_to = "Time", values_to="Rel_Wage")
df.relative.long
```

```{r}
df.relative.path <- aggregate(Rel_Wage ~ clubs + Time, df.relative.long, mean) %>% 
  arrange(clubs)
```

```{r}
path_all <- df.relative.path %>% 
  ggplot(aes(x=Time,y=Rel_Wage, group=clubs, col=clubs)) + geom_line() +
  labs(title = "Transition path of all clubs") +
  theme_bw()
path_all
```

#Generate relative value for within club
#Create dataframe for each club
```{r}
club1 <- nominal.wage.club %>% 
  filter(clubs == "club1")
```

```{r}
relative.club1 <- list()
for(a in 2:14) {
  relative.club1[[a]] <- data.frame(club1$Province, club1[,a]/mean(club1[,a]))
colnames(relative.club1[[a]])[1]<- "Province"
colnames(relative.club1[[a]])[2]<- 
paste("rel",colnames(club1)[a],sep="_")
}

for (x in 2:13) {
  relative.club1[[x+1]]<-left_join(relative.club1[[x]],relative.club1[[x+1]], by="Province")
}
```


```{r}
table.relative.club1 <- map(relative.club1, as.data.table)
df.relative.club1 <- rbindlist(table.relative.club1, fill = T, idcol = T) %>% drop_na()
library(plyr)
df.relative.club1 <- join(df.relative.club1,club1,by=c('Province')) %>% 
  select(Province,contains("rel"),clubs)
  
df.relative.club1
```

```{r}
colnames(df.relative.club1) <- gsub("rel_","",colnames(df.relative.club1))
df.relative.club1
```

```{r}
df.relative.club1.long <- df.relative.club1 %>%  pivot_longer(-c(Province,clubs), names_to = "Time", values_to="Rel_Wage")
df.relative.club1.long
```

```{r}
df.relative.club1.path <- aggregate(Rel_Wage ~ Province + Time, df.relative.club1.long, mean) %>% 
  arrange(Province)
```

```{r}
path_club1 <- df.relative.club1.path %>% 
  ggplot(aes(x=Time,y=Rel_Wage, group=Province, col=Province)) + geom_line() +
  labs(title = "Transition path of regions in Club 1") +
  theme_bw() +
   theme(legend.title = element_text(size = 8), 
               legend.text = element_text(size = 8))
path_club1
```


```{r}
club2 <- nominal.wage.club %>% 
  filter(clubs == "club2")
```

```{r}
relative.club2 <- list()
for(a in 2:14) {
  relative.club2[[a]] <- data.frame(club2$Province, club2[,a]/mean(club2[,a]))
colnames(relative.club2[[a]])[1]<- "Province"
colnames(relative.club2[[a]])[2]<- 
paste("rel",colnames(club2)[a],sep="_")
}

for (x in 2:13) {
  relative.club2[[x+1]]<-left_join(relative.club2[[x]],relative.club2[[x+1]], by="Province")
}
```


```{r}
table.relative.club2 <- map(relative.club2, as.data.table)
df.relative.club2 <- rbindlist(table.relative.club2, fill = T, idcol = T) %>% drop_na()
library(plyr)
df.relative.club2 <- join(df.relative.club2,club2,by=c('Province')) %>% 
  select(Province,contains("rel"),clubs)
  
df.relative.club2
```

```{r}
colnames(df.relative.club2) <- gsub("rel_","",colnames(df.relative.club2))
df.relative.club2
```

```{r}
df.relative.club2.long <- df.relative.club2 %>%  pivot_longer(-c(Province,clubs), names_to = "Time", values_to="Rel_Wage")
df.relative.club2.long
```

```{r}
df.relative.club2.path <- aggregate(Rel_Wage ~ Province + Time, df.relative.club2.long, mean) %>% 
  arrange(Province)
```

```{r}
path_club2 <- df.relative.club2.path %>% 
  ggplot(aes(x=Time,y=Rel_Wage, group=Province, col=Province)) + geom_line() +
  labs(title = "Transition path of regions in Club 2") +
  theme_bw() +
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))
path_club2
#ggsave("path_club2.png")
```

